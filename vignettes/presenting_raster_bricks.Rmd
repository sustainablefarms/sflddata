---
title: "Presenting Raster Bricks"
author: "Kassel Hingee"
date: "12/12/2019"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "..")
```

A document for storing / demonstrating methods for plotting RasterBricks with many layers.

```{r dataimport}
invisible(lapply(c("raster", "maptools", "rgdal", "ncdf4", "lubridate"),
                 library, character.only = TRUE))
invisible(lapply(paste0("./functions/", list.files("./functions")), source))
sws_sites <- readRDS("./private/data/clean/sws_sites.rds")
points <- sws_sites_2_spdf(sws_sites)
b <- brick_fmc(points, 2001:2002)
```

## Using ggplot2
```{r libraryprep}
library(ggplot2)
library(rasterVis)
library(viridis)
```

Facet Grids using two different methods:
```{r facetgrids}
gplot(subset(b, 1:2)) +
  geom_tile(aes(fill = value)) +
  facet_grid(~ variable) + 
  scale_fill_viridis() +
  coord_fixed()
out <- levelplot(subset(b, 1:2))
```


Animate
```{r animate}
library(gganimate)
anim <- gplot(subset(b, 1:10)) +
  geom_tile(aes(fill = value)) +
  scale_fill_viridis() +
  coord_fixed() +
  transition_manual(variable) +
  ggtitle("Fuel Moisture Content at {current_frame}") +
  xlab("Longitude") + ylab("Latitude")
animate(anim, duration = 5)
```

Export an animation
```{r exportanim}
exportdir <- tempdir()
anim_save(filename = "testanimsave.gif", path = exportdir)
```

## Spatial Context Information
I think Open Street Maps can not be downloaded direclty using an R package (see https://github.com/dkahle/ggmap/issues/117).
Google maps requires an API key to a google account and possibly for said google account to have a credit card (see help for `register_google` in package ggmap.
Stamen Maps are a possibiity to download using `ggmap`, however it appears `ggmap` creates raster objects for these.

Another option is to download OSM data manually and then import into R.
Downloaded a map by going to https://www.openstreetmap.org/export#map=8/-35.326/148.189 and selecting download via 'Overpass API'.
```{r OSM}
comphome <- "" ##removed for privacy "C:/UserData/hingeek"
st_layers(paste0(comphome, "/", "map.osm"))
lns <- st_read(paste0(comphome, "/", "map.osm"), layer = "lines")
lns <- st_crop(lns, b)
unique(lns$highway)
ggplot() +
  geom_sf(aes(col = highway), data = lns[!is.na(lns$highway), ]) +
  ggtitle("Roads")

lns %>%
  dplyr::mutate(
    highway_coarsetype = dplyr::case_when (
      highway %in% c("secondary", "secondary_link") ~ "large"
    )
  ) %>%
  dplyr::filter(!is.na(highway)) %>%
  dplyr::filter(!is.na(highway_coarsetype)) %>%
  ggplot() + 
  geom_sf(aes(col = highway))
```

```{r}
ggplot() +
  geom_sf(aes(col = highway), data = lns[!is.na(lns$highway), ]) +
  ggtitle("Roads")

ggplot() +
  geom_sf(aes(col = waterway), data = lns[!is.na(lns$waterway), ]) +
  ggtitle("Waterways")


ggplot() +
  geom_sf(data = lns[lns$highway == "primary", "highway"], inherit.aes = FALSE) +
  coord_sf()

gplot(subset(b, 1)) +
  geom_tile(aes(fill = value)) +
  scale_fill_viridis() +
  #do not inherit aes in following because don't want to a fill colour given by value
  geom_sf(data = lns[lns$highway == "primary", "highway"], inherit.aes = FALSE, stat = "sf") + 
  coord_sf() 


  ggplot2::layer(data = lns[lns$highway == "primary", "highway"], geom = "sf", stat = "identity")
as(st_geometry(lns[lns$highway == "primary", "highway"]), Class = "Spatial")
```

http://www.ga.gov.au/scientific-topics/national-location-information/topographic-maps-data/digital-topographic-data

```{r GAdata}
library(sf)
setwd("C:/UserData/hingeek/GA_TOPO_250K_Series_3/Vector_data/")
st_read("Transport.mdb", drivers = "PGeo")
readOGR("Transport.mdb")
rgdal::ogrInfo("PGeo", "Transport.mdb")
```



```{r osm}
library(ggmap)
smap <- get_stamenmap(maptyle = "toner-lines")
ggmap(smap)
```