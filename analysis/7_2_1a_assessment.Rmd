---
title: "Analysis 7_2_1a Model"
author: "Kassel Hingee"
date: "29/05/2020"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(tibble)
library(dplyr)
library(MCMCpack)
library(mclust)
library(corrplot)
library(coda)
library(runjags)
```

## Data Import

```{r importdata, echo = FALSE, include = FALSE}
inputdata <- readRDS("./private/data/clean/7_2_1_input_data.rds")
```
```{r importmodelfit, out.width=14}
fit <- readRDS("./tmpdata/7_2_1_mcmcchain_20200524.rds")
fit <- add.summary(fit)
sm <- as_tibble(summary(fit), rownames = "varname")
print(fit)
```

## MCMC Assessment

### Gelman-Rubin Statistic (aka "Rhat" or psrf)
Values less than 1.1 are desired.

```{r gelmanrubin}
sm %>%
  dplyr::filter((psrf >= 1.1) | is.na(psrf)) %>%
  dplyr::select(varname) %>%
  as.list()
```

No coefficients failed the Gelman-Rubin threshold (except lv.coef[1,2] which forced to be zero).
Many were close though.

### Selected Traces
```{r traceplots}
plot(fit, plot.type = "trace", vars = grep("lv.coef\\[.*,1\\]", sm$varname, value = TRUE),
     layout = c(2, 5))
plot(fit, plot.type = "trace", vars = grep("lv.coef\\[([2-9]|[1-9].).*,2\\]", sm$varname, value = TRUE),
     layout = c(2, 5))
plot(fit, plot.type = "trace", vars = sm$varname[[1]], separate.chains = TRUE, layout = c(5, 1))
plot(fit, plot.type = "trace", vars = grep("u.b\\[.*,1\\]", sm$varname, value = TRUE),
     layout = c(3, 5))
```

Some of the u.b covariates look a bit like there is still correlation.

### Densities: comparing chains
```{r ggmcmc_prep}
library(ggmcmc)
fit.ggs <- ggs(coda::as.mcmc.list(fit), sort = TRUE)  
```

```{r densities, fig.width = 12, fig.height = 10}
ggs_density(fit.ggs, family = "lv.coef\\[.*,1\\]") + facet_wrap(~ Parameter) + ggtitle("1st LV")
ggs_density(fit.ggs, family = "lv.coef\\[.*,2\\]") + facet_wrap(~ Parameter) + ggtitle("2nd LV")
ggs_density(fit.ggs, family = "(lv.coef\\[1,1\\]|lv.coef\\[2,2\\])") + facet_wrap(~ Parameter) + ggtitle("Sign-fixing LV Coefficients")
ggs_density(fit.ggs, family = "^mu.u.b") + facet_wrap(~ Parameter, scales = "free")
ggs_density(fit.ggs, family = "^mu.v.b") + facet_wrap(~ Parameter, scales = "free")
ggs_density(fit.ggs, family = "^u.b") + facet_wrap(~ Parameter, scales = "free")
ggs_density(fit.ggs, family = "^v.b") + facet_wrap(~ Parameter, scales = "free")
```

Density plots don't really say much - there are too many of them!


### Geweke
See http://www.ugrad.stat.ubc.ca/R/library/coda/html/geweke.diag.html for a very quick description of this.
The Geweke values are Z-scores.
95% of (independent) Geweke values should be within 2 standard deviations (i.e. just 2 for Z-scores) of the mean.

```{r gewekesumm}
gewekevals <- geweke.diag(fit) #joins all chains together
hist(gewekevals$z)
```

Geweke values across when chains are merged look pretty good.

```{r chainwise}
gwk_chainwise <- ggs_geweke(fit.ggs, plot = FALSE)
gwk_chainwise %>%
  ggplot() +
  facet_wrap(~Chain) +
  geom_histogram(aes(x = z))
gwk_chainwise %>%
  ggplot() +
  facet_wrap(~Chain) +
  geom_qq(aes(sample = z)) +
  geom_qq_line(aes(sample = z))
```

The above plots, per chain, should look very standard Gaussian or Student-T shaped (haven't looked into theory yet).
They all look pretty close.
I think this is a good confirmation of convergence.

```{r gewekeplots, fig.height=15}
ggs_geweke(fit.ggs, family = "^u.b\\[1,*") + scale_colour_viridis_d(option = "inferno") 
ggs_geweke(fit.ggs, family = "^[v].*") + scale_colour_viridis_d(option = "inferno")
ggs_geweke(fit.ggs, family = "^[mt].*") + scale_colour_viridis_d(option = "inferno")
ggs_geweke(fit.ggs, family = "^l.*\\]$") + scale_colour_viridis_d(option = "inferno")
```

### Autocorrelation
The runjags summary function has computed autocorrelation up to 100 iterations (equal to 10 samples). We'd like it if the autocorrelation was close 0. Auto-correlation of most parameters less than 0.1. Some are greater than 0.1 though, and these a spread between u.b, v.b, and lv.coef values.

```{r autocorr_fromsummary}
hist(fit$summaries[, "AC.500"])
sm %>% 
  filter(AC.500 >= 0.1) %>% 
  dplyr::select(varname, AC.500) %>%
  deframe()
```

**Even at a thinning rate of 50, many u.b and v.b values have high autocorrelation.** Does it matter? 

