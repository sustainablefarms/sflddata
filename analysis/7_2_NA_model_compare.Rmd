---
title: "Compare Ground, Remote Sensing and Climate Models"
author: "Kassel Hingee"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    collapsed: no
    number_sections: yes
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_root(rprojroot::has_file("DESCRIPTION")))
devtools::load_all(rprojroot::find_root(rprojroot::has_file("DESCRIPTION")))
knitr::opts_chunk$set(echo = FALSE)
library(tibble)
library(dplyr)
library(MCMCpack)
library(mclust)
library(corrplot)
library(coda)
library(runjags)
library(ggplot2)
library(patchwork)
```

## Data Import

Importing holdout and insample estimates of expected log posterior density.

```{r import_lpd}
inputdata <- readRDS("./private/data/clean/7_2_10_input_data.rds")

lpds_l <- c(readRDS("./tmpdata/7_2_10_lpds.rds"),
            readRDS("./tmpdata/7_2_11_lpds.rds"),
            readRDS("./tmpdata/7_2_12_lpds.rds"),
            readRDS("./tmpdata/7_2_13_lpds.rds"))
waics_l <- c(readRDS("./tmpdata/7_2_10_waics.rds"),
             readRDS("./tmpdata/7_2_11_waics.rds"),
             readRDS("./tmpdata/7_2_12_waics.rds"),
             readRDS("./tmpdata/7_2_13_waics.rds")
             )

stopifnot(setequal(names(lpds_l), names(waics_l)))

# remove non-convergent MCMC models
unconverged <- c("twiwoody500mgppdiff_gppmean" , "twiwoody500mgppdiffgppmean", "twiwoody500mgppdiff",
                 "latlon", "latlon_year")
lpds_l <- lpds_l[!(names(lpds_l) %in% unconverged)]
waics_l <- waics_l[!(names(waics_l) %in% unconverged)]
Enums_holdout <- readRDS("./tmpdata/7_3_01b_many_Enum_holdout.rds")[names(lpds_l)]
Enums_insample <- readRDS("./tmpdata/7_3_01b_many_Enum_insample.rds")[names(lpds_l)]
```

```{r modelclassnames}
rs <- setdiff(names(readRDS("./tmpdata/7_2_13_lpds.rds")), "interceptsonly")
grnd <- names(readRDS("./tmpdata/7_2_11_lpds.rds"))
climate <-  c(names(readRDS("./tmpdata/7_2_10_lpds.rds")), names(readRDS("./tmpdata/7_2_12_lpds.rds")))

modelname2type <- function(modelnames){
  modeltype <- case_when(
    modelnames %in% c("interceptsonly", "intercepts_only") ~ "interceptsonly",
    modelnames %in% rs ~ "remote",
    modelnames %in% climate ~ "climate",
    modelnames %in% grnd ~ "ground",
    TRUE ~ "other"
    )
  return(modeltype)
}
```

```{r varname2type}
varname2type <- function(varnames){
  types <- case_when(
    grepl("lv.coef", varnames) ~ "LV Load",
    grepl("LV", varnames) ~ "LV",
    grepl("^(mu|tau)", varnames) ~ "Comm Param", #parameters of community distributions
    grepl("^u.b", varnames) ~ "Occu Coef",
    grepl("^v.b", varnames) ~ "Detn Coef",
    TRUE ~ "other"
    )
  return(types)
}
```

## LPD of Holdout Data
```{r holdoutlpd, fig.height = 8}
melpd <- data.frame(Estimate = vapply(lpds_l, function(x) mean(x$lpds), FUN.VALUE = 3.3),
                    SE = vapply(lpds_l, function(x) return(sd(x$lpds) / sqrt(length(x$lpds))), FUN.VALUE = 3.3 ))

lpds_df <- as_tibble(lapply(lpds_l, function(x) x$lpds))


mean_2se <- function(x, mult = 2, na.rm = TRUE){
  if (na.rm == TRUE){x <- na.omit(x)}
  n <- length(x)
  xbar <- sum(x)/n
  sd <- sqrt(sum((x - xbar)^2)/(n - 1))
  return(c(ymin = xbar - mult * sd / sqrt(n),
           y = xbar,
           ymax = xbar + mult * sd / sqrt(n)))
}

modordered <- intersect(c(grnd, rs, climate, "interceptsonly"), names(lpds_df))

lpds_df %>%
  as_tibble() %>%
  tidyr::pivot_longer(everything(), names_to = "model", values_to = "Site_lpd") %>%
  dplyr::mutate(modeltype =  modelname2type(model)) %>%
  ggplot() +
  geom_violin(aes(x = Site_lpd, y = model, col = modeltype),
              adjust = 0.2,
              position = position_dodge(1),
              draw_quantiles = c(0.1, 0.25, 0.5, 0.75, 0.9)) +
  stat_summary(aes(x = Site_lpd, y = model),
               fun.data=mean_2se, fun.args = list(mult=2, na.rm = TRUE), geom="crossbar", width=0.2 ) +
  scale_y_discrete(limits = rev(modordered)) +
  ggtitle("Log-Posterior Density of Holdout ModelSites")
```

Below is the lpd computed for each ModelSite for both the InSample and out of sample data.

## LPD of In-Sample Data
```{r distributioninsampleoutsamplelpd, fig.height= 9}
insamplelpds_df <- do.call(cbind, lapply(waics_l, function(x) x$waic$pointwise[, "elpd_waic"])) %>%
  as_tibble() %>%
  tidyr::pivot_longer(everything(), names_to = "model", values_to = "site_lpd") %>%
  mutate(InSample = TRUE)

holdoutlpds_df <- lpds_df %>% as_tibble() %>% 
  tidyr::pivot_longer(everything(), names_to = "model", values_to = "site_lpd") %>%
  mutate(InSample = FALSE)

df <- bind_rows(insamplelpds_df, holdoutlpds_df)


df %>%
  as_tibble() %>%
  dplyr::mutate(modeltype = modelname2type(model)) %>%
  ggplot() +
  facet_grid(rows = vars(modeltype), scales = "free", space = "free_y" ) +
  geom_violin(aes(x = site_lpd, y = model, col = InSample), position = position_dodge(1), adjust = 0.2) +
  geom_point(aes(x = site_lpd, y = model, col = InSample), position = position_dodge(1),
              shape = "+", alpha = 0.5) +
  stat_summary(aes(x = site_lpd, y = model, group = InSample),
               fun.data=mean_2se, fun.args = list(mult=2), geom="crossbar", width=0.2, position = position_dodge(1) ) +
  theme(strip.text.y.right = element_text(angle = 0)) +
  ggtitle("Log Posterior Density of ModelSites")
```

## WAIC, LOO-PSIS and Holdout
```{r waics, fig.height = 10}
waics_average_elpd_per_point <- lapply(waics_l, function(x) x$waic$estimates["elpd_waic", ]/nrow(x$waic$pointwise))
waics_average_elpd_per_point <- simplify2array(waics_average_elpd_per_point)
waics_average_elpd_per_point <- t(waics_average_elpd_per_point) %>% as_tibble(rownames = "Model")
waics_average_elpd_per_point$type = "WAIC"

loo_average_elpd_per_point <- lapply(waics_l, function(x) x$loo$estimates["elpd_loo", ]/nrow(x$waic$pointwise))
loo_average_elpd_per_point <- simplify2array(loo_average_elpd_per_point)
loo_average_elpd_per_point <- t(loo_average_elpd_per_point) %>% as_tibble(rownames = "Model")
loo_average_elpd_per_point$type = "LOO-PSIS"

melpd$type <- "Holdout"
melpd <- as_tibble(melpd, rownames = "Model")

df <- bind_rows(waics_average_elpd_per_point, loo_average_elpd_per_point, melpd)

df %>%
  dplyr::mutate(modeltype =  modelname2type(Model)) %>%
  ggplot() +
  facet_grid(rows = vars(modeltype), scales = "free_y", space = "free_y") +
  geom_errorbar(aes(x = Model, ymax = Estimate +  2*SE, ymin = Estimate - 2*SE, col = type, lty = type)) +
  geom_point(aes(x = Model, y = Estimate, col = type), position = position_jitter(width = 0.1)) +
  coord_flip() +
  theme(strip.text.y.right = element_text(angle = 0)) +
  ggtitle("Estimates of Log Posterior Density for a new ModelSite")
```

There is only one model where the new (better) LOO-PSIS estimates are different to the WAIC estimates.

## Compare within 2 units of Deviance
```{r deviance2units}
looics <- simplify2array(lapply(waics_l, function(x) x$loo$estimates["looic", ]))
t(looics) %>%
  as_tibble(rownames = "Model") %>%
  dplyr::mutate(modeltype = modelname2type(Model)) %>%
  ggplot() +
  facet_grid(rows = vars(modeltype), scales = "free_y", space = "free_y") +
  geom_errorbarh(aes(xmin = Estimate - 2, xmax = Estimate + 2, y = Model)) +
  geom_point(aes(x = Estimate, y = Model)) +
  ggtitle("LOOIC - Estimates of WAIC in Deviance Scale")
```

## Model Difference, lpd per site
```{r holdoutdiffs}
plot_compare_loo <- function(compare.loo.obj){
  plt <- compare.loo.obj %>%
    as_tibble(rownames = "Model") %>%
    dplyr::mutate(modeltype = modelname2type(Model)) %>%
    ggplot() +
    geom_errorbarh(aes(xmin = elpd_diff - 2 * se_diff, xmax = elpd_diff + 2 * se_diff,
                       y = Model)) +
    geom_point(aes(x = elpd_diff, y = Model)) +
    geom_vline(xintercept = 0, col = "blue") +
    scale_x_continuous("Pointwise Difference in Expected Log Posterior Density (Summed)")
  return(plt)
}
```

```{r difflpd_rsground, fig.height = 7}
elpd_compare(lpds_df, refname = "interceptsonly") %>%
  plot_compare_loo() +
  facet_grid(rows = vars(modeltype), scales = "free_y", space = "free_y") +
  theme(strip.text.y.right = element_text(angle = 0)) +
  ggtitle("Holdout Differences")
elpd_compare(do.call(cbind, lapply(waics_l, function(x) x$loo$pointwise[, 1])),
             refname = "interceptsonly") %>%
  plot_compare_loo() +
  facet_grid(rows = vars(modeltype), scales = "free_y", space = "free_y") +
  theme(strip.text.y.right = element_text(angle = 0)) +
  ggtitle("LOO-PSIS Differences")
elpd_compare(do.call(cbind, lapply(waics_l, function(x) x$loo$pointwise[, 1]))) %>%
  plot_compare_loo() +
  facet_grid(rows = vars(modeltype), scales = "free_y", space = "free_y") +
  theme(strip.text.y.right = element_text(angle = 0)) +
  ggtitle("LOO-PSIS Differences")
loo::loo_compare(lapply(waics_l, function(x) x$loo))
```

Note that someclimate_year is the model with occupancy formula:
1 + AnnMeanTemp + AnnPrec + AnnTempRange + PrecSeasonality + SurveyYear + PrecWarmQ

Note that moreclimate_year is the model with occupancy formula:
1 + AnnMeanTemp + AnnPrec + AnnTempRange + PrecSeasonality + SurveyYear + PrecWarmQ + MnTDryQ + PrecDryMonth

### Within Model Type
```{r loocompare_withinmodeltype}
loo::loo_compare(lapply(waics_l[names(waics_l) %in% grnd], function(x) x$loo)) %>%
  plot_compare_loo() +
  facet_grid(rows = vars(modeltype = modelname2type(Model)), scales = "free_y", space = "free_y") +
  theme(strip.text.y.right = element_text(angle = 0)) +
  ggtitle("Ground: LOO-PSIS Differences")

loo::loo_compare(lapply(waics_l[names(waics_l) %in% rs], function(x) x$loo)) %>%
  plot_compare_loo() +
  facet_grid(rows = vars(modeltype = modelname2type(Model)), scales = "free_y", space = "free_y") +
  theme(strip.text.y.right = element_text(angle = 0)) +
  ggtitle("Remote: LOO-PSIS Differences")

loo::loo_compare(lapply(waics_l[names(waics_l) %in% climate], function(x) x$loo)) %>%
  plot_compare_loo() +
  facet_grid(rows = vars(modeltype = modelname2type(Model)), scales = "free_y", space = "free_y") +
  theme(strip.text.y.right = element_text(angle = 0)) +
  ggtitle("Climate: LOO-PSIS Differences")
```

## Expected Number of Species for Each Model Site
```{r EnumspeciesHoldout, fig.height = 10}
obsnumbers <- detectednumspec(inputdata$holdoutdata$yXobs[, inputdata$species], 
                              inputdata$holdoutdata$yXobs[, "ModelSiteID", drop = TRUE])
Enum_det <- do.call(cbind, lapply(Enums_holdout, function(x) x["Esum_det", , drop = TRUE]))
Vnum_det <- do.call(cbind, lapply(Enums_holdout, function(x) x["Vsum_det", , drop = TRUE]))

Enum_compare(obsnumbers, Enum_det, Vnum_det)
meanplt <- Enum_compare(obsnumbers, Enum_det, Vnum_det) %>%
  as_tibble(rownames = "Model") %>%
  dplyr::mutate(modeltype = modelname2type(Model)) %>%
  tidyr::pivot_longer(starts_with("SE"), names_to = "SEtype", values_to = "SE") %>%
  ggplot() +
  facet_grid(rows = vars(modeltype), scales = "free_y", space = "free_y") +
  geom_vline(xintercept = 0, col = "blue") +
  geom_errorbarh(aes(xmin = `E[D]_obs` - 2 * SE, xmax = `E[D]_obs` + 2 * SE,
                   y = Model,
                   col = SEtype, lty = SEtype)) +
  geom_point(aes(x = `E[D]_obs`, y = Model)) +
  scale_x_continuous("Mean Residual") +
  ggtitle("Holdout: Mean Residual of Number of Detected Spccies")

varplt <- Enum_compare(obsnumbers, Enum_det, Vnum_det) %>%
  as_tibble(rownames = "Model") %>%
  dplyr::mutate(modeltype = modelname2type(Model)) %>%
  tidyr::pivot_longer(starts_with("V"), names_to = "Vtype", values_to = "Variance") %>%
  ggplot() +
  facet_grid(rows = vars(modeltype), scales = "free_y", space = "free_y") +
  geom_point(aes(x = sqrt(Variance), y = Model, col = Vtype)) +
  scale_x_continuous("Standard Deviation of Residual") +
  ggtitle("Holdout: Standard Deviation of Number of Detected Species")

print(meanplt / varplt)

data.frame(Observed = obsnumbers, Enum_det, ModelSiteID = as.integer(names(obsnumbers))) %>%
  tidyr::pivot_longer(c(-ModelSiteID, -Observed), names_to = "Model", values_to = "Number of Species") %>%
  dplyr::mutate(modeltype = modelname2type(Model)) %>%
  left_join(data.frame(Vnum_det, ModelSiteID = as.integer(names(obsnumbers))) %>%
               tidyr::pivot_longer(-ModelSiteID, names_to = "Model", values_to = "Vnumber"), by = c("Model", "ModelSiteID")) %>%
  ggplot() +
  facet_grid(rows = vars(Model), scales = "free_y", space = "free_y") +
  geom_ribbon(aes(x = ModelSiteID, ymin = `Number of Species` - 2 * sqrt(Vnumber), ymax = `Number of Species` + 2 * sqrt(Vnumber)),
              fill = "grey") +
  geom_point(aes(x = ModelSiteID, y = `Number of Species`)) +
  geom_point(aes(x = ModelSiteID, y = Observed), col = "red") +
  theme(strip.text.y.right = element_text(angle = 0)) +
  ggtitle("Holdout Data: Number of Species Detected at Each Model Site")

data.frame(obsnumbers - Enum_det, ModelSiteID = as.integer(names(obsnumbers))) %>%
  tidyr::pivot_longer(c(-ModelSiteID), names_to = "Model", values_to = "Residual") %>%
  left_join(data.frame(Vnum_det, ModelSiteID = as.integer(names(obsnumbers))) %>%
               tidyr::pivot_longer(-ModelSiteID, names_to = "Model", values_to = "Vresidual"), by = c("Model", "ModelSiteID")) %>%
  ggplot() +
  facet_grid(rows = vars(Model)) +
  geom_ribbon(aes(x = ModelSiteID, ymin = - 2 * sqrt(Vresidual), ymax = + 2 * sqrt(Vresidual)),
              fill = "grey") +
  geom_point(aes(x = ModelSiteID, y = Residual), col = "red") +
  geom_hline(yintercept = 0, col = "blue") +
  theme(strip.text.y.right = element_text(angle = 0)) +
  ggtitle("Holdout Data: Residual Number of Species Detected at Each Model Site")
```

```{r EnumspeciesInsample, fig.height = 10}
obsnumbers <- detectednumspec(inputdata$insampledata$yXobs[, inputdata$species], 
                              inputdata$insampledata$yXobs[, "ModelSiteID", drop = TRUE])
Enum_det <- do.call(cbind, lapply(Enums_insample, function(x) x["Esum_det", , drop = TRUE]))
Vnum_det <- do.call(cbind, lapply(Enums_insample, function(x) x["Vsum_det", , drop = TRUE]))

Enum_compare(obsnumbers, Enum_det, Vnum_det)
meanplt <- Enum_compare(obsnumbers, Enum_det, Vnum_det) %>%
  as_tibble(rownames = "Model") %>%
  dplyr::mutate(modeltype = modelname2type(Model)) %>%
  tidyr::pivot_longer(starts_with("SE"), names_to = "SEtype", values_to = "SE") %>%
  ggplot() +
  facet_grid(rows = vars(modeltype), scales = "free_y", space = "free_y") +
  geom_vline(xintercept = 0, col = "blue") +
  geom_errorbarh(aes(xmin = `E[D]_obs` - 2 * SE, xmax = `E[D]_obs` + 2 * SE,
                   y = Model,
                   col = SEtype, lty = SEtype)) +
  geom_point(aes(x = `E[D]_obs`, y = Model)) +
  scale_x_continuous("Mean Residual") +
  ggtitle("Insample: Mean Residual of Number of Detected Spccies")

varplt <- Enum_compare(obsnumbers, Enum_det, Vnum_det) %>%
  as_tibble(rownames = "Model") %>%
  dplyr::mutate(modeltype = modelname2type(Model)) %>%
  tidyr::pivot_longer(starts_with("V"), names_to = "Vtype", values_to = "Variance") %>%
  ggplot() +
  facet_grid(rows = vars(modeltype), scales = "free_y", space = "free_y") +
  geom_point(aes(x = sqrt(Variance), y = Model, col = Vtype)) +
  scale_x_continuous("Standard Deviation of Residual") +
  ggtitle("Insample: Standard Deviation of Number of Detected Species")

print(meanplt / varplt)
```

## Conclusions
Most important looking sets of variables in each model type are:
+ someclimate_year
+ msnm
+ woody500m

Will try 4 new models combining these additively pairwise, and all 3.

Then to the best of these will apply detection models.
Then will apply best detection model to all 4 models plus best models from each type.

