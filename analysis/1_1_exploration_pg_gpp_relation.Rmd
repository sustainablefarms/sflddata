---
title: 'Exploration: Precipitation and Gross Primary Product'
author: "Kassel Hingee"
date: "03/12/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "..")
library("tsibble"); library(lubridate); library(ggplot2); library(tidyr); library(grid); library(gridExtra); library(feasts); library(dplyr); library(gtable)
```

```{r import and prep data}
#load data and convert to tsibbles
load("./data/pg_daily.Rdata")
pg_daily$times <- as_date(pg_daily$times)
pg <- pg_daily %>%
  pivot_longer(-times, names_to = "site", values_to = "pg") %>%
  as_tsibble(key = site, index = times)
load("./data/gpp_8d.Rdata")
gpp <- gpp_8d %>%
  pivot_longer(-times, names_to = "site", values_to = "gpp") %>%
  as_tsibble(key = site, index = times)
pggpp <- as_tsibble(dplyr::full_join(pg, gpp, by = c("times", "site")), key = site, index = times)
```

## Example Plot of a Year at a Site
```{r year_at_site, echo=FALSE}
pgplot <- pggpp %>%
  dplyr::filter(site == "BELL1") %>%
  tsibble::filter_index("2009") %>%
  ggplot() +
  geom_line(aes(times, pg)) +
  ggtitle("BELL1 Precipitation for 2009")
gppplot <- gpp %>%
  dplyr::filter(site == "BELL1") %>%
  tsibble::filter_index("2009") %>%
  ggplot() +
  geom_line(aes(times, gpp)) +
  ggtitle("BELL1 GPP for 2009")
grid.draw(rbind(ggplotGrob(pgplot), ggplotGrob(gppplot), size = "last"))
```

The data set has 176 different sites (some sites are missing due to longitude and latitude not being saved in the sites .rds). At each location there is a 20 year time series of daily precipitation data (6940 days), and 8-day GPP data (874 days).
Dimensions within this data:
+ spatial (environmental gradients too?)
+ precipitation
+ GPP

## Are there any interesting years for BELL1?

### Precipitation at BELL1
The precipitation in each year is difficult to compare as there is a lot of variation at the daily-scale (first plot below).
Smoothing across multiple months show there are some years that have unusually high precipitation during some of the seasons (second plot below).
The years where smoothed precipitation is greater than 4 on some day are shown in the third figure.
```{r seasonal_pg_at_BELL1_smoothed, echo = FALSE}
pggpp %>%
  dplyr::filter(site == "BELL1") %>%
  feasts::gg_season(pg, max_col = 25) +
  ggtitle("BELL1 Precipitation")
tmpts <- pggpp %>%  
  dplyr::filter(site == "BELL1") %>%
  dplyr::mutate(smoothedpg = slide_dbl(pg, ~ weighted.mean(., w = dnorm(-30:30, sd = 15), na.rm = TRUE), .size = 61, .align = "c")) 


tmpts %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  index_by(yday = ~ yday(.)) %>%
  group_by(year) %>%
  ggplot() +
  geom_line(aes(yday, smoothedpg, color = year)) +
  ggtitle("BELL1 Smoothed Precipitation")


maxes <- tmpts  %>%
  index_by(year(times)) %>%
  dplyr::summarize(max = max(smoothedpg, na.rm = TRUE))
max_smoothedpg_year <- function(year){
  maxes[as.numeric(year) - 2000 + 1, "max"]
}

tmpts  %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  dplyr::filter(max_smoothedpg_year(year(times)) > 4) %>%  # only years with maximum smoothedpg greater than this threshold plotted
  index_by(yday = ~ yday(.)) %>%
  ggplot() +
  geom_line(aes(yday, smoothedpg, color = year)) +
  ggtitle("BELL1 Smoothed Precipitation: Unusually High Years")

```

Interesting that the smoothed precipitation can be so large in Summer. This could be purely due to the weighted average method; the sum over a month might be easier to relate to reality. Total precipitation per month is below.

```{r seasonal_pg_at_BELL1_monthly, echo = FALSE}
pg_by_yearmonth <- pggpp %>%  
  dplyr::filter(site == "BELL1") %>%
  index_by(ym = yearmonth(times)) %>%
  summarise(monthlypg = sum(pg))

pg_by_yearmonth %>%
  dplyr::mutate("year" = factor(year(ym))) %>%
  index_by(month  = month(ym)) %>% 
  ggplot() +
  #geom_col(aes(month, totalpg, color = year), position = "dodge") +
  geom_step(aes(month, monthlypg, color = year)) +
  ggtitle("BELL1 Monthly Precipitation")


maxes_monthly <- pg_by_yearmonth  %>%
  index_by(year(ym)) %>%
  dplyr::summarize(max = max(monthlypg, na.rm = TRUE))
max_monthlypg_year <- function(year){
  maxes_monthly[as.numeric(year) - 2000 + 1, "max"]
}

pg_by_yearmonth  %>%
  dplyr::mutate("year" = factor(year(ym))) %>%
  dplyr::filter(max_monthlypg_year(year(ym)) > quantile(maxes_monthly$max, 0.90)) %>%  # only years with a monthly pg greater than this threshold plotted
  index_by(m = ~ month(.)) %>%
  ggplot() +
  geom_step(aes(m, monthlypg, color = year)) +
  ggtitle("BELL1 Monthly Precipitation: Unusually High Years")

pg_by_yearmonth  %>%
  dplyr::mutate("year" = factor(year(ym))) %>%
  dplyr::filter(max_monthlypg_year(year(ym)) < quantile(maxes_monthly$max, 0.10)) %>%  # only years with a monthly pg greater than this threshold plotted
  index_by(m = ~ month(.)) %>%
  ggplot() +
  geom_step(aes(m, monthlypg, color = year)) +
  ggtitle("BELL1 Monthly Precipitation: Unusually Low Years")
```

### GPP at BELL1
To compare seasons using the automated method GPP values must have values for the same days every year, which is not usually the case due to the 8 day frequency of the GPP data. Below solves this using a 61 day weighted average.
```{r seasonal_gpp_at_BELL1, echo = FALSE}
tmpts <- pggpp %>%
  dplyr::filter(site == "BELL1") %>%
  dplyr::mutate(meangpp = slide_dbl(gpp, ~ weighted.mean(., w = dnorm(-30:30, sd = 15), na.rm = TRUE), .size = 61, .align = "c")) 
tmpts %>%
  dplyr::filter(site == "BELL1") %>%
  feasts::gg_season(meangpp, max_col = 25) +
  ggtitle("BELL1 Smoothed GPP")
```

## Precipitation and GPP at BELL1
```{r smoothedpg_vs_gpp_old, echo = FALSE, eval = FALSE}
# old plotting code, saved here for more use
pgplot <- pggpp %>%
  dplyr::filter(site == "BELL1") %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  tsibble::filter_index("2009", "2012", "2016") %>%
  index_by(yday = ~ yday(.)) %>%
  ggplot() +
  facet_grid(cols = vars(year)) + 
  geom_line(aes(yday, pg)) +
  geom_smooth(aes(yday, pg), method = "loess", formula = y ~ x, span = 0.1, show.legend = TRUE) + 
  ggtitle("BELL1 Smoothed Precipitation")
gppplot <- gpp %>%
  dplyr::filter(site == "BELL1") %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  tsibble::filter_index("2009", "2012", "2016") %>%
  index_by(yday = ~ yday(.)) %>%
  ggplot() +
  facet_grid(cols = vars(year)) + 
  geom_line(aes(yday, gpp)) +
  ggtitle("BELL1 GPP")
grid.draw(rbind(ggplotGrob(pgplot), ggplotGrob(gppplot), size = "last")) #uses gtable's rbind needed for x-axis to match
#note could possibly do above easily using faceting and melt/pivot_longer
```

```{r bell1_smoothedpg_vs_gpp, echo = FALSE}
pggpp %>%
  tsibble::filter_index("2006", "2009", "2012", "2016", "2018") %>%
  dplyr::filter(site == "BELL1") %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  pivot_longer(cols = c("pg", "gpp"), names_to = "variable", values_to = "value",
               names_ptypes = list(variable = factor(levels = c("pg", "gpp")))) %>% #converts measurement into a key value
  group_by(yday = yday(times)) %>%  #pivot_long so that warning to do with pivoting into factors doesn't occur, but no longer tsibble so index_by doesn't work
  ggplot() +
  ggtitle("BELL1: GPP and Precipitation") +
  facet_grid(rows = vars(variable), cols = vars(year), scales = "free_y") + 
  geom_point(aes(yday, value), size = 0.5, na.rm = TRUE) +
  stat_summary_bin(aes(yday, value),
           data = function(x) dplyr::filter(x, variable == "pg"), #so binning only applies to pg data
           colour = "blue",
           fun.y = sum,
           binwidth = 30,
           geom = "step")

  # Following code could be used to create a smoothing instead of binning
  # geom_smooth(aes(yday, value),
  #             data = function(x) dplyr::filter(x, variable == "pg"), #so smoothing only applies to pg data
  #             method = "loess", formula = y ~ x, span = 0.1, show.legend = TRUE, na.rm = TRUE) 
```
At BELL1 there is a relation between precipitation and GPP, however it is obscured by a seasonal trend in GPP to increase in spring. This seasonal trend seems to be present even for low rainfall - could it be due to farm management, or instinctive plant behaviour?


## Precipitation and GPP for Other sites
```{r bell1_smoothedpg_vs_gpp, echo = FALSE}
pggpp %>%
  tsibble::filter_index("2006", "2009", "2012", "2016", "2018") %>%
  dplyr::filter(site == "ARCH1") %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  pivot_longer(cols = c("pg", "gpp"), names_to = "variable", values_to = "value",
               names_ptypes = list(variable = factor(levels = c("pg", "gpp")))) %>% #converts measurement into a key value
  group_by(yday = yday(times)) %>%  #pivot_long so that warning to do with pivoting into factors doesn't occur, but no longer tsibble so index_by doesn't work
  ggplot() +
  ggtitle("ARCH1: GPP and Precipitation") +
  facet_grid(rows = vars(variable), cols = vars(year), scales = "free_y") + 
  geom_point(aes(yday, value), size = 0.5, na.rm = TRUE) +
  stat_summary_bin(aes(yday, value),
           data = function(x) dplyr::filter(x, variable == "pg"), #so binning only applies to pg data
           colour = "blue",
           fun.y = sum,
           binwidth = 30,
           geom = "step")
```