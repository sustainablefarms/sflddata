---
title: 'Exploration: Precipitation and Gross Primary Product'
author: "Kassel Hingee"
date: "03/12/2019"
output:
  html_document:
    toc: true
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
out <- lapply(c("sf", "tsibble", 'lubridate', "viridis",
                'ggplot2', 'tidyr', 'grid', 'gridExtra', 
                'feasts', 'dplyr', 'gtable'),
       library, character.only = TRUE)
out <- lapply(paste0("../functions/", list.files("../functions/")), source)
```

```{r import and prep data}
#load data and convert to tsibbles
load("./private/data/remote_sensed/pg_daily.Rdata")
pg_daily$times <- as_date(pg_daily$times)
pg <- pg_daily %>%
  pivot_longer(-times, names_to = "site", values_to = "pg") %>%
  as_tsibble(key = site, index = times)
load("./private/data/remote_sensed/gpp_8d.Rdata")
gpp <- gpp_8d %>%
  pivot_longer(-times, names_to = "site", values_to = "gpp") %>%
  as_tsibble(key = site, index = times)
pggpp <- as_tsibble(dplyr::full_join(pg, gpp, by = c("times", "site")), key = site, index = times)
```

## Example Plot of a Year at a Site
```{r year_at_site, echo=FALSE}
pgplot <- pggpp %>%
  dplyr::filter(site == "BELL1") %>%
  tsibble::filter_index("2009") %>%
  ggplot() +
  geom_line(aes(times, pg)) +
  ggtitle("BELL1 Precipitation for 2009")
gppplot <- gpp %>%
  dplyr::filter(site == "BELL1") %>%
  tsibble::filter_index("2009") %>%
  ggplot() +
  geom_line(aes(times, gpp)) +
  ggtitle("BELL1 GPP for 2009")
grid.draw(rbind(ggplotGrob(pgplot), ggplotGrob(gppplot), size = "last"))
```

The data set has 176 different sites (some sites are missing due to longitude and latitude not being saved in the sites .rds). At each location there is a 20 year time series of daily precipitation data (6940 days), and 8-day GPP data (874 days).
Dimensions within this data:
+ spatial (environmental gradients too?)
+ precipitation
+ GPP

## Histograms of GPP and PG
```{r histogramgpp}
sws_sites <- sws_sites_2_sf(readRDS("./private/data/clean/sws_sites.rds")) %>%
  mutate(latitude =  sf::st_coordinates(geometry)[, "Y"],
         longitude = sf::st_coordinates(geometry)[, "X"]) 
pggpp %>%
  ggplot() +
  geom_histogram(aes(x = gpp), binwidth = 0.1) +
  ggtitle("Histogram of GPP Values")

prop0 <- sum(0 >= pggpp$gpp, na.rm = TRUE) / (pggpp$gpp %>% is.finite() %>% sum())
```

The proportion of zero valued gpp measurements is `r prop0`, whjich is about 0.5%. As they aren't outliers they could possibly be ignored if fitting a logarithmic model.

```{r histogrampg}
pggpp %>%
  ggplot() +
  geom_histogram(aes(x = pg, y = ..density..), binwidth = 0.5) +
  ggtitle("Histogram of Precipitation Observations") +
  scale_x_continuous(limits = c(-1, 20))

prop0 <- sum(0 >= pggpp$pg, na.rm = TRUE) / (pggpp$pg %>% is.finite() %>% sum())
```

There are many zero values in the pg measuremens, `r prop0` of all pg measurements are zero.

## Are there any interesting years for BELL1?

### Precipitation at BELL1
The precipitation in each year is difficult to compare as there is a lot of variation at the daily-scale (first plot below).
Smoothing across multiple months show there are some years that have unusually high precipitation during some of the seasons (second plot below).
The years where smoothed precipitation is greater than 4 on some day are shown in the third figure.

```{r seasonal_pg_at_BELL1_smoothed, echo = FALSE}
pggpp %>%
  dplyr::filter(site == "BELL1") %>%
  feasts::gg_season(pg, max_col = 25) +
  ggtitle("BELL1 Precipitation")
tmpts <- pggpp %>%  
  dplyr::filter(site == "BELL1") %>%
  dplyr::mutate(smoothedpg = slide_dbl(pg, ~ weighted.mean(., w = dnorm(-30:30, sd = 15), na.rm = TRUE), .size = 61, .align = "c")) 


tmpts %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  index_by(yday = ~ yday(.)) %>%
  group_by(year) %>%
  ggplot() +
  geom_line(aes(yday, smoothedpg, color = year)) +
  ggtitle("BELL1 Smoothed Precipitation")


maxes <- tmpts  %>%
  index_by(year(times)) %>%
  dplyr::summarize(max = max(smoothedpg, na.rm = TRUE))
max_smoothedpg_year <- function(year){
  maxes[as.numeric(year) - 2000 + 1, "max"]
}

tmpts  %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  dplyr::filter(max_smoothedpg_year(year(times)) > 4) %>%  # only years with maximum smoothedpg greater than this threshold plotted
  index_by(yday = ~ yday(.)) %>%
  ggplot() +
  geom_line(aes(yday, smoothedpg, color = year)) +
  ggtitle("BELL1 Smoothed Precipitation: Unusually High Years")

```

Interesting that the smoothed precipitation can be so large in Summer. This could be purely due to the weighted average method; the sum over a month might be easier to relate to reality. Total precipitation per month is below.

```{r seasonal_pg_at_BELL1_monthly, echo = FALSE}
pg_by_yearmonth <- pggpp %>%  
  dplyr::filter(site == "BELL1") %>%
  index_by(ym = yearmonth(times)) %>%
  summarise(monthlypg = sum(pg))

pg_by_yearmonth %>%
  dplyr::mutate("year" = factor(year(ym))) %>%
  index_by(month  = month(ym)) %>% 
  ggplot() +
  #geom_col(aes(month, totalpg, color = year), position = "dodge") +
  geom_step(aes(month, monthlypg, color = year)) +
  ggtitle("BELL1 Monthly Precipitation")


maxes_monthly <- pg_by_yearmonth  %>%
  index_by(year(ym)) %>%
  dplyr::summarize(max = max(monthlypg, na.rm = TRUE))
max_monthlypg_year <- function(year){
  maxes_monthly[as.numeric(year) - 2000 + 1, "max"]
}

pg_by_yearmonth  %>%
  dplyr::mutate("year" = factor(year(ym))) %>%
  dplyr::filter(max_monthlypg_year(year(ym)) > quantile(maxes_monthly$max, 0.90)) %>%  # only years with a monthly pg greater than this threshold plotted
  index_by(m = ~ month(.)) %>%
  ggplot() +
  geom_step(aes(m, monthlypg, color = year)) +
  ggtitle("BELL1 Monthly Precipitation: Unusually High Years")

pg_by_yearmonth  %>%
  dplyr::mutate("year" = factor(year(ym))) %>%
  dplyr::filter(max_monthlypg_year(year(ym)) < quantile(maxes_monthly$max, 0.10)) %>%  # only years with a monthly pg greater than this threshold plotted
  index_by(m = ~ month(.)) %>%
  ggplot() +
  geom_step(aes(m, monthlypg, color = year)) +
  ggtitle("BELL1 Monthly Precipitation: Unusually Low Years")
```

### GPP at BELL1
To compare seasons using the automated method GPP values must have values for the same days every year, which is not usually the case due to the 8 day frequency of the GPP data. Below solves this using a 61 day weighted average.
```{r seasonal_gpp_at_BELL1, echo = FALSE}
tmpts <- pggpp %>%
  dplyr::filter(site == "BELL1") %>%
  dplyr::mutate(meangpp = slide_dbl(gpp, ~ weighted.mean(., w = dnorm(-30:30, sd = 15), na.rm = TRUE), .size = 61, .align = "c")) 
tmpts %>%
  dplyr::filter(site == "BELL1") %>%
  feasts::gg_season(meangpp, max_col = 25) +
  ggtitle("BELL1 Smoothed GPP")
```

## Precipitation and GPP at BELL1
```{r smoothedpg_vs_gpp_old, echo = FALSE, eval = FALSE}
# old plotting code, saved here for more use
pgplot <- pggpp %>%
  dplyr::filter(site == "BELL1") %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  tsibble::filter_index("2009", "2012", "2016") %>%
  index_by(yday = ~ yday(.)) %>%
  ggplot() +
  facet_grid(cols = vars(year)) + 
  geom_line(aes(yday, pg)) +
  geom_smooth(aes(yday, pg), method = "loess", formula = y ~ x, span = 0.1, show.legend = TRUE) + 
  ggtitle("BELL1 Smoothed Precipitation")
gppplot <- gpp %>%
  dplyr::filter(site == "BELL1") %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  tsibble::filter_index("2009", "2012", "2016") %>%
  index_by(yday = ~ yday(.)) %>%
  ggplot() +
  facet_grid(cols = vars(year)) + 
  geom_line(aes(yday, gpp)) +
  ggtitle("BELL1 GPP")
grid.draw(rbind(ggplotGrob(pgplot), ggplotGrob(gppplot), size = "last")) #uses gtable's rbind needed for x-axis to match
#note could possibly do above easily using faceting and melt/pivot_longer
```

```{r bell1_smoothedpg_vs_gpp, echo = FALSE}
pggpp %>%
  tsibble::filter_index("2006", "2009", "2012", "2016", "2018") %>%
  dplyr::filter(site == "BELL1") %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  pivot_longer(cols = c("pg", "gpp"), names_to = "variable", values_to = "value",
               names_ptypes = list(variable = factor(levels = c("pg", "gpp")))) %>% #converts measurement into a key value
  group_by(yday = yday(times)) %>%  #pivot_long so that warning to do with pivoting into factors doesn't occur, but no longer tsibble so index_by doesn't work
  ggplot() +
  ggtitle("BELL1: GPP and Precipitation") +
  facet_grid(rows = vars(variable), cols = vars(year), scales = "free_y") + 
  geom_point(aes(yday, value), size = 0.5, na.rm = TRUE) +
  stat_summary_bin(aes(yday, value),
           data = function(x) dplyr::filter(x, variable == "pg"), #so binning only applies to pg data
           colour = "blue",
           fun.y = sum,
           binwidth = 30,
           geom = "step")

  # Following code could be used to create a smoothing instead of binning
  # geom_smooth(aes(yday, value),
  #             data = function(x) dplyr::filter(x, variable == "pg"), #so smoothing only applies to pg data
  #             method = "loess", formula = y ~ x, span = 0.1, show.legend = TRUE, na.rm = TRUE) 
```

At BELL1 there is a relation between precipitation and GPP, however it is obscured by a seasonal trend in GPP to increase in spring. This seasonal trend seems to be present even for low rainfall - could it be due to farm management, or instinctive plant behaviour?


## Precipitation and GPP for Other sites
```{r varioussites_smoothedpg_vs_gpp, echo = FALSE, fig.height = 10}
sitenames <- unique(pggpp$site)
sitesample <- sample(sitenames, size = 4)
pggpp %>%
  tsibble::filter_index("2006", "2009", "2012", "2016", "2018") %>%
  dplyr::mutate("year" = factor(year(times))) %>%
  pivot_longer(cols = c("pg", "gpp"), names_to = "variable", values_to = "value",
               names_ptypes = list(variable = factor(levels = c("pg", "gpp")))) %>% #converts measurement into a key value
  group_by(yday = yday(times)) %>%  #pivot_long so that warning to do with pivoting into factors doesn't occur, but no longer tsibble so index_by doesn't work
  dplyr::filter(site %in% sitesample) %>%
  ggplot() +
  ggtitle("Various Sites: GPP and Precipitation") +
  facet_grid(rows = vars(site, variable), cols = vars(year), scales = "free_y") + 
  geom_point(aes(yday, value), size = 0.5, na.rm = TRUE) +
  stat_summary_bin(aes(yday, value),
           data = function(x) dplyr::filter(x, variable == "pg"), #so binning only applies to pg data
           colour = "blue",
           fun.y = sum,
           binwidth = 30,
           geom = "step")
```

The above confirms that for other sites, there seems to be both a seasonal shape to GPP and an influence by the amount of rainfall.

## *Interlude*: Modelling Hypotheses
+ in the neighbourhood of any location there is a constant amount of GPP that depends on vegetation type/amount, climate, subsurface water, soil etc.
  + this could be mean GPP in a dry year and could be close to mean GPP across time
+ there is an intrinsic seasonal amplification/increase of GPP that is unrelated to weather (due to habits in nature, amount of sunlight etc)
  + it probably depends on elevation, climate and latitude 
+ there is an amplification/increase of GPP in response to rainfall

The first two items above can be combined into a single function that depends on day of the year and location, but not on the particular year, nor on the amount of rain. Thus model could be of the form:
$$y_i(t_{yr}) = s_i(t_{yr}) \times f_i(rain(t))$$
or 
$$y_i(t_{yr}) = s_i(t_{yr}) + f_i(rain(t))$$
where $t$ is the date, $t_{yr}$ is the date modulo year, and $rain$ is a function that depends on the rain prior to $t$.
The interest is in:
 1. Does the model fit well?
 2. Are parameters of $f_i$ related to grazing pressure and abundance/diversity of speices
The form and parameters of $s_i$ are thus just inconveniences.

## Exploring the spatial variation in seasonal dependence (without rain)
Two ways to avoid rain could be to take the median GPP at each `yday`, or 0.1 quantile of GPP on each `yday`.
The former is influenced by high-amounts of rain, the latter is influenced by extreme drought; neither is representative of the climate.
Perhaps a more robust method would be to use climate data and exclude years/seasons that are far from the mean for this climate.

I suspect median might be sufficiently robust to extreme years.
The following computes the median of smoothed GPP (smoothed needed to compare years) for a single site.

```{r yday_median_at_BELL1, echo = FALSE}
BELL1 <- pggpp %>%
  dplyr::filter(site == "BELL1") %>%
  #dplyr::mutate(tsmoothgpp = slide_dbl(gpp, ~ weighted.mean(., w = dnorm(-30:30, sd = 15), na.rm = TRUE), .size = 61, .align = "c")) %>%
  mutate(lininterp_gpp = zoo::na.approx(gpp, rule = 1, na.rm = FALSE))

medianBELL1 <- BELL1 %>%
  index_by(yday = yday(times)) %>% 
  dplyr::summarise(medGPP = median(lininterp_gpp, na.rm = TRUE),
                   nGPP = sum(!is.na(lininterp_gpp)))
ggplot(medianBELL1) +
  geom_point(aes(x = yday, y = medGPP)) +
  geom_line(aes(x = yday, y = nGPP/3), col = "grey") +
  scale_y_continuous(sec.axis = sec_axis(~. * 3, name = "Number of Non-NA Smoothed GP")) +
  ggtitle("Median GPP at BELL1")
```


```{r plotBELL1medianwithothers}
BELL1 %>%
  index_by(yday = yday(times)) %>%
  ggplot() +
  geom_jitter(aes(x = yday, y = gpp, col = year(times)), size = 1) +
  #geom_point(aes(x = yday, y = gpp, col = year(times)), shape = 45, size = 10) +
  scale_colour_viridis() +
  geom_line(aes(x = yday, y = medGPP), data = medianBELL1) +
  ggtitle("Median GPP of BELL1 with observed GPP at BELL1")
```

The following computed median for each site:
```{r allsitesmedian}
pggpp <- pggpp %>%
  mutate(yday = yday(times)) %>%
  group_by_key() %>% #key is site
  mutate(lininterp_gpp = zoo::na.approx(gpp, rule = 1, na.rm = FALSE))

medianGPP <- pggpp %>%
  index_by(yday = yday(times)) %>% 
  dplyr::summarise(medGPP = median(lininterp_gpp, na.rm = TRUE),
                   nGPP = sum(!is.na(lininterp_gpp)))
#the following checked median computed correctly for BELL1
stopifnot(all.equal((medianGPP %>%  filter(site == "BELL1"))$medGPP, medianBELL1$medGPP))

medianGPP %>%
  index_by(yday) %>%
  ggplot() +
  geom_bin2d(aes(x = yday, y = medGPP), binwidth = c(1, 0.3)) + 
  scale_fill_viridis(begin = 0) + 
  ggtitle("Median Daily GPP")
```

Daily median GPP appears roughly single mode in each day of the year, with greater spread during spring.

Theory is that this median depends on climate. I'd really love to see how it varies across latitude, elevation and climatic variables.

```{r sitevars}
sws_sites <- sws_sites_2_sf(readRDS("./private/data/clean/sws_sites.rds")) %>%
  mutate(latitude =  sf::st_coordinates(geometry)[, "Y"],
         longitude = sf::st_coordinates(geometry)[, "X"]) 
medianGPP %>%
  left_join(sws_sites, by = c("site" = "SiteCode")) %>%
  ggplot() +
  geom_jitter(aes(x = yday, y = medGPP, col = elevation), size = 0.1) +
  facet_grid(cols = vars(cut(longitude, breaks = 10)),
             rows = vars(cut(latitude, breaks = 10)),
             as.table = FALSE) +
  scale_colour_viridis() +
  ggtitle("Median Daily GPP", subtitle = "Faceted by longitude and latitude, coloured by elevation")
```

Shapes are very similar across all locations. It looks like peak GPP  would work as a summary statistic and might make it easier to see if there is an association between median daily GPP and elevation, longitude or latitude.

```{r summaryusingpeakGPP}
medianGPP %>%
  as_tibble() %>%
  group_by(site) %>%
  summarise(max_medGPP = quantile(medGPP, 0.9, na.rm = TRUE)) %>%
  left_join(sws_sites, by = c("site" = "SiteCode")) %>%
  ggplot() +
  geom_point(aes(x = longitude, y = latitude, col = max_medGPP)) +
  scale_colour_viridis() +
  ggtitle("Year-Max of Median Daily GPP", subtitle = "by site location")

medianGPP %>%
  as_tibble() %>%
  group_by(site) %>%
  summarise(max_medGPP = quantile(medGPP, 0.9, na.rm = TRUE)) %>%
  left_join(sws_sites, by = c("site" = "SiteCode")) %>%
  ggplot() +
  geom_point(aes(x = elevation, y = max_medGPP)) +
  scale_colour_viridis() +
  ggtitle("Year-Max of Median Daily GPP", subtitle = "by elevation")
```

There appears to be very little trend related to elevation, longitude or latitude. Model-based analysis will be more rigorous for this.

How about against oldgrowth, regrowth and planting.
```{r medianGPPvsGrowthType}
medianGPP %>%
  left_join(sws_sites, by = c("site" = "SiteCode")) %>%
  ggplot() +
  geom_bin2d(aes(x = yday, y = medGPP), binwidth = c(1, 0.3)) + 
  scale_fill_viridis() +
  facet_grid(cols = vars(GrowthType),
             as.table = FALSE) +
  ggtitle("median GPP vs Growth Type")

a <- medianGPP %>%
  as_tibble() %>%
  group_by(site) %>%
  summarise(max_medGPP = quantile(medGPP, 0.9, na.rm = TRUE)) %>%
  left_join(sws_sites, by = c("site" = "SiteCode")) %>%
  ggplot() +
  geom_violin(aes(x = GrowthType, y = max_medGPP)) + 
  scale_fill_viridis() +
  ggtitle("max daily median GPP vs Growth Type")
b <- medianGPP %>%
  as_tibble() %>%
  group_by(site) %>%
  summarise(max_medGPP = quantile(medGPP, 0.9, na.rm = TRUE)) %>%
  left_join(sws_sites, by = c("site" = "SiteCode")) %>%
  ggplot() +
  geom_boxplot(aes(x = GrowthType, y = max_medGPP)) + 
  scale_fill_viridis() +
  ggtitle("max daily median GPP vs Growth Type")
grid.draw(cbind(ggplotGrob(a), ggplotGrob(b), size = "last"))
```

The above, particulary the box plot, suggests the typical maximum of daily median GPP is not correlated with growth type.

#### A slight trend in decreading maximum yday-median GPP with Native Vegetation Amount
Warning different native vegetation amounts could be recorded for each site. This would make the following flawed.

```{r medianGPPvsNativeVegArea}
tmptbl <- medianGPP %>%
  as_tibble() %>%
  group_by(site) %>%
  summarise(max_medGPP = quantile(medGPP, 0.9, na.rm = TRUE)) %>%
  left_join(sws_sites, by = c("site" = "SiteCode")) 

ggplot(tmptbl) +
  geom_point(aes(x = NativeVegArea500mRadius, y = max_medGPP)) + 
  geom_smooth(aes(x = NativeVegArea500mRadius, y = max_medGPP), method = "lm") +
  scale_colour_viridis() +
  ggtitle("max daily median GPP vs amount of native vegetation nearby")
```


Appears to be some trend towards decreasing max daily GPP with increasing amounts of native vegetation. I'm guessing native vegetation correlates strongly with area of woody vegetation (*we can check this*), which makes me wonder we are seeing the effect of grasses for grazing or crops increasing in greenness.

```{r lmfitfornativevegarea}
lmfit <- lm(max_medGPP ~ NativeVegArea500mRadius, data = tmptbl)
summary(lmfit)
par(mfrow = c(2, 2))
plot(lmfit)
tmptbl %>%
  mutate(rownumber = row_number()) %>%
  ggplot() +
  geom_point(aes(x = NativeVegArea500mRadius, y = max_medGPP)) +
  geom_point(aes(x = NativeVegArea500mRadius, y = max_medGPP), data = . %>% slice(c(31, 53, 54, 103)), col = "red") + 
  geom_text(aes(x = NativeVegArea500mRadius, y = max_medGPP, label = paste(site, rownumber)),
            data = . %>% slice(c(31, 53, 54, 103)),
            col = "red", nudge_x = 5) 
```

In my (naive) opinion diagnostic plots show that the model is ok with only some outliers and one point of high leverage. However the model does not explain much of the variation.

*There is variation in the yday-median GPP but no strong correlations with the available variables have been found.*

## GPP / yday-median GPP vs rainfall
```{r compute_gpp_over_medianGPP}
a <- pggpp %>% left_join(medianGPP, by = c("site" = "site", "yday" = "yday")) %>%
  mutate(rel_gpp = gpp / medGPP)
a %>%
  pivot_longer(cols = c("pg", "gpp", "rel_gpp"), names_to = "variable", values_to = "value") %>%
  filter(site == "BELL1") %>%
  ggplot() +
  facet_grid(rows = vars(variable), scales = "free_y") +
  geom_point(aes(times, value), size = 0.1, na.rm = TRUE) +
  geom_line(aes(times, medGPP, colour = "yday-median GPP"))
```

In the above it looks like relative median GPP has the potential to have extreme values for years that are wet in unusal seasons.

```{r relGPP_vs_smoothpg}
a %>%
  filter(site == "BELL1", times > "2001-01-01", times < "2005-12-31") %>%
  mutate(pgcum = slide_dbl(pg, ~ weighted.mean(., w = dnorm(-45:15, sd = 10), na.rm = TRUE), .size = 61, .align = "r")) %>%
  ggplot() +
  geom_line(aes(times, pgcum, colour = "weighted av of pg"),
            #col = "blue",
            show.legend = TRUE) +
  geom_line(aes(x = times, y = rel_gpp + 5, colour = "GPP relative to Median"),
             data = function(x) x %>% filter(!is.na(rel_gpp)),
             na.rm = TRUE) +
  scale_y_continuous(sec.axis = sec_axis(~ . - 5, name = "GPP relative to Median")) +
  # geom_rug(aes(x = times, y = pg, colour = pg), inherit.aes = FALSE, sides = "b") +
  stat_summary_bin(aes(times, pg /10),
         colour = "blue",
         fun.y = sum,
         binwidth = 30,
         na.rm = TRUE,
         inherit.aes = FALSE) +
  # scale_colour_viridis() +
  ggtitle("Rainfall and GPP Relative to Median at BELL1") +
  theme(legend.direction = "horizontal", legend.position = "bottom")
```

## Automatic decomposition methods
```{r decompose}
decompose(pggpp)
```

  
## Missing Explorations
+ exploring autocorrelation of GPP across years
+ exploring stationarity of GPP
+ using Fourier analysis to model annual seasonality